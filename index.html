<!--
  StarWorld Crew Status Board
  ===========================
  A real-time, shareable status board inspired by AIM, early Twitter status, and Facebook’s check-ins.
  Hosted as a static site on Netlify with Firebase Realtime Database for shared, global updates.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome to StarWorld! Leave a status 💋</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="index.css">

  <!-- Firebase & dynamic crew loader -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
    import { getDatabase, ref, onValue, set } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js';

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "<YOUR_FIREBASE_API_KEY>",
      authDomain: "starworld-status.firebaseapp.com",
      databaseURL: "https://starworld-status-default-rtdb.firebaseio.com",
      projectId: "starworld-status",
      storageBucket: "starworld-status.firebaseio.com",
      messagingSenderId: "16992867929",
      appId: "1:16992867929:web:30e7282dbdbae346414348"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Track editing state for each status box
    let isEditing = {};

    // Listen for status updates (Firebase listener adjusted)
    onValue(ref(db, 'statuses'), snapshot => {
      const data = snapshot.val() || {};

      Object.entries(data).forEach(([id, { text, timestamp }]) => {
        const statusEl = document.querySelector(`.crew-member[data-id="${id}"] .status`);
        const indEl = document.querySelector(`.crew-member[data-id="${id}"] .save-indicator`);

        if (statusEl && indEl && !isEditing[id]) { // Only update if not actively editing
          statusEl.textContent = text;
          indEl.textContent = formatTimeAgo(timestamp);
        }
      });
    });


    // Load crew members from CSV
    document.addEventListener('DOMContentLoaded', async () => {
      const rawCsv = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGJIsPg6buMXJoOvQFH9QM0-yqN5ZuY61Qm8pqE_DA-t6Q0F0erryj2jTN8kdybvZ-g7fFWBuhv0v5/pub?gid=720196244&single=true&output=csv';
      const proxy = 'https://corsproxy.io/?';
      const board = document.querySelector('.crew-board');

      const resp = await fetch(proxy + encodeURIComponent(rawCsv));
      const text = await resp.text();
      const rows = text.trim().split('\n').slice(1);

      rows.forEach(line => {
        const [handle, short_name, full_name, title] = line.split(',');
        const member = document.createElement('div');
        member.className = 'crew-member';
        member.dataset.id = short_name;

        member.innerHTML = `
          <div class="member-content">
            <div class="member-info">
              <div class="avatar"></div>
              <div class="member-text">
                <span class="name">${short_name}</span>
                <span class="title">${title}</span>
              </div>
            </div>
            <div class="member-status">
              <div class="status" contenteditable="true" data-placeholder="Click to leave a status…"></div>
              <div class="save-indicator">Never saved</div>
            </div>
          </div>
        `;
        board.appendChild(member);

        // Silent avatar load
        const avatarDiv = member.querySelector('.avatar');
        const img = new Image();
        img.onload = () => avatarDiv.appendChild(img);
        img.onerror     = event => {
          // stop browser from drawing a broken-image icon
          event.preventDefault && event.preventDefault();
          // optional: add a class so you can style “missing” avatars in CSS
          avatarDiv.classList.add('avatar--missing');
          console.warn(`Failed to load avatar for ${handle}`);
        };
        img.src = `./${handle}.png`;

        // Debounced save
        const statusEl = member.querySelector('.status');
        const indEl = member.querySelector('.save-indicator');
        statusEl.addEventListener('input', debounce(async () => {
          const ts = Date.now();
          await set(ref(db, `statuses/${short_name}`), { text: statusEl.textContent, timestamp: ts });
          indEl.textContent = 'Last saved: Just now';
          indEl.classList.add('pulse');
          setTimeout(() => indEl.classList.remove('pulse'), 1200);
        }, 500));
      });
    });

    // Utilities
    function debounce(fn, wait) {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }
    function formatTimeAgo(ts) {
      const d = Date.now() - ts;
      if (d < 60000) return `${Math.floor(d/1000)}s ago`;
      if (d < 3600000) return `${Math.floor(d/60000)}m ago`;
      if (d < 86400000) return `${Math.floor(d/3600000)}h ago`;
      return `${Math.floor(d/86400000)}d ago`;
    }
  </script>
</head>
<body>
  <h1>Welcome to StarWorld! Leave a status 💋</h1>
  <div class="crew-board"></div>
</body>
</html>
